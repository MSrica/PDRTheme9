---
title: 'Tema 9'
author: 'Hana Rut Lerga, Mateo Srica, Ivana Stimac'
date: '2023-05-28'
output: html_document
---

## Setup
```{r setup}
rm(list = ls())
setwd('C:\\Users\\srica\\Desktop\\Radio\\projekt\\PDR Tema 9')
if (!file.exists('plots')) dir.create('plots')
if (!file.exists('distances')) dir.create('distances')

library(stringr)
```

## Constants
```{r constants}
constants <- data.frame(
  fiPole     = 78.3 * pi / 180,
  lambdaPole = 291 * pi / 180,
  
  ippHeight   = 350,
  earthRadius = 6378,
  lightSpeed  = 2.99792458e+08
)
print(constants)
```

## User coordinates
```{r user coordinates}
# receiver (user) cooridinates (Pevex Kukuljanovo)
userFiLambda <- data.frame(
  fiUser = 45.331360488178596*(pi/180), # longitude
  lambdaUser = 14.509391791906435*(pi/180) # latitude
)
print(userFiLambda)

# real Cartesian receiver (user) coordinates
userCoords <- data.frame(
  X = constants$earthRadius * cos(userFiLambda$lambdaUser) * cos(userFiLambda$fiUser),
  Y = constants$earthRadius * cos(userFiLambda$lambdaUser) * sin(userFiLambda$fiUser),
  Z = constants$earthRadius * sin(userFiLambda$lambdaUser)
)
print(userCoords)
```

## Rinex, alpha and beta
```{r rinex, alpha and beta}
ionisation <- data.frame(
  alphaIon <- c(1.4900e-08, -7.4510e-09, -5.9600e-08, 1.1920e-07),
  betaIon  <- c(1.2900e+05, -1.9660e+05, 6.5540e+04, 3.2770e+05)
)
  
print(ionisation$alphaIon)
print(ionisation$betaIon)
```

## sp3 data
```{r sp3 data}
firstDate <- NA
sp3DataFormatted <- list()
sp3Data <- read.delim('data\\data.SP3', header=FALSE)

for (rowIndex in 23:nrow(sp3Data)-1) {
  row <- str_split(str_trim(gsub('\\s+', ' ', sp3Data[rowIndex, ])), ' ')[[1]]

  # * year month day hour minutes seconds
  if (length(row) == 7) {  
    dateTime <- strptime(paste(row[2], row[3], row[4], row[5], row[6]), format = "%Y %m %d %H %M")
    if (is.na(firstDate)) firstDate <- dateTime
    gpsTime <- as.numeric(difftime(dateTime, firstDate, units='mins'))
    next
  }
  
  # id x y z clock deviations
  data = data.frame(DateTime=dateTime,
                    GPSTime=gpsTime,
                    X=as.numeric(row[2]),
                    Y=as.numeric(row[3]),
                    Z=as.numeric(row[4]))

  sp3DataFormatted[[row[1]]] <- rbind(sp3DataFormatted[[row[1]]], data)
}

rm(rowIndex, row, data, dateTime, gpsTime, firstDate)
```

## Data calculations and saving
```{r calculation function}
getIonDist <- function(gpsData){
  elevation <- gpsData$Z - userCoords$Z
  azimuth <- atan((gpsData$X - userCoords$X) - (gpsData$Y - userCoords$Y))
  
  psi <- pi / 2 - elevation - asin(constants$earthRadius / (constants$earthRadius + constants$ippHeight) * cos(elevation))
  fiIon <- asin(sin(userFiLambda$fiUser) * cos(psi) + cos(userFiLambda$fiUser) * sin(psi) * cos(azimuth))
  lambdaIon <- userFiLambda$lambdaUser + psi * sin(azimuth) / cos(fiIon)
  fiMag <- asin(sin(fiIon) * sin(constants$fiPole) + cos(fiIon) * cos(constants$fiPole) * cos(lambdaIon - constants$lambdaPole))
  
  time <- 43200 * lambdaIon / pi + gpsData$GPSTime
  if (time >= 86400) time <- time - 86400
  if (time < 0) time <- time + 86400
  
  azimuthIon <- 0
  for (i in seq(1, 4, 1)) azimuthIon <- azimuthIon + ionisation$alphaIon[i] * `^`(fiMag / pi, i - 1)
  if (azimuthIon < 0) azimuthIon <- 0
  
  psiIon <- 0
  for (i in seq(1, 4, 1)) psiIon <- psiIon + as.double(ionisation$betaIon[i]) * `^`(fiMag / pi, i - 1)
  if (psiIon > 72000) psiIon <- 72000
  
  xIon <- 2 * pi * (time - 50400) / psiIon
  Fun <- `^`(1 - `^`(constants$earthRadius / (constants$earthRadius + constants$ippHeight) * cos(elevation), 2), -1 / 2)
  
  if (abs(xIon) < pi / 2) dIon <- (5e-9 + azimuthIon * cos(xIon)) * Fun
  else dIon <- 5e-9 * Fun
  dIon <- dIon * constants$lightSpeed
  
  diffXSquared <- (userCoords$X - gpsData$X) ** 2
  diffYSquared <- (userCoords$Y - gpsData$Y) ** 2
  diffZSquared <- elevation ** 2

  distance <- sqrt(diffXSquared + diffYSquared + diffZSquared) * 1000 + dIon
  
  return(list(dIon=dIon, distance=distance))
}
```

```{r saving function}
saveData <- function(gpsName, lines, ionVector){
  fileConn <- file(paste('distances/', gpsName, 'output.txt'))
  writeLines(lines, fileConn)
  close(fileConn)
  
  time <- seq(0, 24, len=289)
  plot(time, ionVector, type='l', main=str_interp(paste('Klobucharov model za', gpsName)), xlab='time[h]', ylab='dIon[m]')
  
  png(paste('plots/', gpsName, 'plot.png'), width=20, height=10, units='cm', res=500)
  plot(time, ionVector, type='l', main=str_interp(paste('Klobucharov model za', gpsName)), xlab='time[h]', ylab='dIon[m]')
  dev.off()
}
```

```{r data calculations and saving}
emptySpaces     <- strrep(' ', 25)
timestampHeader <- substr(str_interp('TIME [s]${emptySpaces}'), 0, 10)
distanceHeader  <- substr(str_interp('DISTANCE [m]${emptySpaces}'), 0, 15)
header          <- str_interp('${timestampHeader} ${distanceHeader}')

for(gpsName in names(sp3DataFormatted)){
  lines <- header
  ionVector <- c()
  
  for(gpsIndex in 1:nrow(sp3DataFormatted[[gpsName]])){
    gpsData <- sp3DataFormatted[[gpsName]][gpsIndex, ]
    
    ionDist   <- getIonDist(gpsData)
    ionVector <- append(ionVector, ionDist$dIon)
    
    gpsTimeFormatted  <- substr(str_interp('${gpsData$GPSTime}${emptySpaces}'), 0, 10)
    distanceFormatted <- substr(str_interp('${ionDist$distance}${emptySpaces}'), 0, 15)
    lines <- append(lines, str_interp('${gpsTimeFormatted} ${distanceFormatted}'))
  }
  
  saveData(gpsName, lines, ionVector)
  print(paste('Finished', gpsName))
}

rm(distanceFormatted, distanceHeader, emptySpaces, gpsIndex, gpsName, gpsTimeFormatted, header, ionVector, lines, timestampHeader)
```